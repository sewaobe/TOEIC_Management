import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  NotificationsNone,
  Chat,
  ErrorOutline,
  Comment,
  Info,
} from "@mui/icons-material";
import {
  Badge,
  Popper,
  Paper,
  ClickAwayListener,
  List,
  ListItem,
  ListItemAvatar,
  Avatar,
  ListItemText,
  Divider,
  Typography,
  Box,
  Fade,
  Button,
  Tooltip,
  IconButton,
  CircularProgress,
} from "@mui/material";
import { useTheme } from "@mui/material/styles";
import { useNotifications } from "../hooks/useNotifications";
import { Notification } from "../types/Notification";
import NotificationDetailDialog from "./NotificationDetailDialog";

const MotionIconButton = motion(IconButton);

export default function NotificationDropdown() {
  const theme = useTheme();
  const {
    notifications,
    unreadCount,
    markAsRead,
    markAllAsRead,
    hasNew,
    resetNew,
    loadMore,
    hasMore,
    isLoading,
  } = useNotifications();

  const [selectedNotif, setSelectedNotif] = useState<Notification | null>(null);
  const [openDetail, setOpenDetail] = useState(false);
  const [isDialogClosing, setIsDialogClosing] = useState(false); // ‚úÖ NEW

  const handleOpenDetail = (notif: Notification) => {
    setSelectedNotif(notif);
    setOpenDetail(true);
    if (!notif.isRead) markAsRead(notif.id);
  };

  const handleCloseDetail = () => {
    setIsDialogClosing(true); // ‚úÖ ƒë√°nh d·∫•u ƒëang ƒë√≥ng dialog
    setOpenDetail(false);
    setTimeout(() => setIsDialogClosing(false), 250); // ƒë·ª£i animation xong r·ªìi reset
  };

  const [anchorEl, setAnchorEl] = useState<HTMLElement | null>(null);
  const open = Boolean(anchorEl);

  useEffect(() => {
    if (hasNew) {
      const timer = setTimeout(() => resetNew(), 1200);
      return () => clearTimeout(timer);
    }
  }, [hasNew, resetNew]);

  const handleToggle = (event: React.MouseEvent<HTMLElement>) => {
    setAnchorEl(open ? null : event.currentTarget);
  };
  const handleClose = () => setAnchorEl(null);

  const renderIcon = (type: string) => {
    switch (type) {
      case "chat":
        return <Chat sx={{ color: theme.palette.primary.main }} fontSize="small" />;
      case "comment":
        return <Comment sx={{ color: theme.palette.success.main }} fontSize="small" />;
      case "error":
        return <ErrorOutline sx={{ color: theme.palette.error.main }} fontSize="small" />;
      case "system":
        return <Info sx={{ color: theme.palette.text.secondary }} fontSize="small" />;
      default:
        return <NotificationsNone sx={{ color: theme.palette.text.primary }} fontSize="small" />;
    }
  };

  const getAvatarColor = (type: string) => {
    switch (type) {
      case "chat":
        return theme.palette.info.light;
      case "comment":
        return theme.palette.success.light;
      case "error":
        return theme.palette.error.light;
      case "system":
        return theme.palette.grey[200];
      default:
        return theme.palette.background.paper;
    }
  };

  return (
    <>
      {/* üîî N√∫t chu√¥ng */}
      <Tooltip title="Th√¥ng b√°o" enterDelay={300}>
        <MotionIconButton
          color="default"
          onClick={handleToggle}
          sx={{
            p: 1,
            bgcolor: open ? theme.palette.action.hover : "transparent",
            "&:hover": { bgcolor: theme.palette.action.hover },
            position: "relative",
          }}
          animate={hasNew ? { rotate: [0, -15, 15, -10, 10, 0] } : {}}
          transition={{ duration: 0.6 }}
        >
          <Badge
            badgeContent={unreadCount > 0 ? unreadCount : null}
            color="error"
            overlap="circular"
            sx={{
              "& .MuiBadge-badge": {
                fontSize: "0.7rem",
                height: "18px",
                minWidth: "18px",
              },
            }}
          >
            <NotificationsNone sx={{ fontSize: 26 }} />
          </Badge>
          {hasNew && (
            <span className="absolute -top-0.5 -right-0.5 w-3 h-3 bg-red-500 rounded-full animate-ping"></span>
          )}
        </MotionIconButton>
      </Tooltip>

      {/* üí¨ Popper Dropdown */}
      <Popper
        open={open}
        anchorEl={anchorEl}
        placement="bottom-end"
        transition
        modifiers={[{ name: "offset", options: { offset: [0, 8] } }]}
      >
        {({ TransitionProps }) => (
          <Fade {...TransitionProps} timeout={200}>
            <Paper
              sx={{
                width: 340,
                maxHeight: 440,
                overflowY: "auto",
                borderRadius: 2,
                boxShadow: theme.shadows[4],
                backgroundColor: theme.palette.background.paper,
                scrollbarWidth: "thin", // Firefox
                "&::-webkit-scrollbar": {
                  width: "6px",
                },
                "&::-webkit-scrollbar-thumb": {
                  backgroundColor: theme.palette.grey[400],
                  borderRadius: "3px",
                },
              }}
            >
              <ClickAwayListener
                onClickAway={(event) => {
                  if (openDetail || isDialogClosing) return;
                  handleClose();
                }}
              >
                <Box>
                  {/* Header */}
                  <Box
                    sx={{
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      px: 2,
                      py: 1.5,
                      borderBottom: `1px solid ${theme.palette.divider}`,
                      backgroundColor: theme.palette.action.hover,
                    }}
                  >
                    <Typography variant="subtitle1" fontWeight={600}>
                      Th√¥ng b√°o
                    </Typography>
                    <Button
                      size="small"
                      onClick={markAllAsRead}
                      sx={{
                        color: theme.palette.primary.main,
                        textTransform: "none",
                        fontWeight: 600,
                      }}
                    >
                      ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                    </Button>
                  </Box>

                  {/* Danh s√°ch */}
                  <List disablePadding>
                    {notifications.length === 0 ? (
                      <Typography
                        variant="body2"
                        color="text.secondary"
                        sx={{ textAlign: "center", py: 4, fontWeight: 500 }}
                      >
                        Kh√¥ng c√≥ th√¥ng b√°o
                      </Typography>
                    ) : (
                      <AnimatePresence initial={false}>
                        {notifications.map((n, idx) => (
                          <motion.div
                            key={n.id || n.createdAt}
                            initial={{ opacity: 0, y: -6 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, y: -6 }}
                            transition={{ duration: 0.25 }}
                          >
                            <ListItem
                              alignItems="flex-start"
                              onClick={() => handleOpenDetail(n)}
                              sx={{
                                cursor: "pointer",
                                p: 1.5,
                                borderRadius: 2,
                                bgcolor: n.isRead
                                  ? "transparent"
                                  : theme.palette.mode === "light"
                                    ? `${theme.palette.primary.main}1F` // m√†u primary nh·∫°t (opacity 12%)
                                    : `${theme.palette.primary.light}22`,
                                "&:hover": {
                                  bgcolor: theme.palette.action.selected,
                                  transform: "translateY(-1px)",
                                  transition: "all 0.15s ease-in-out",
                                },
                                transition: "background-color 0.2s",
                              }}
                            >
                              <ListItemAvatar>
                                <Avatar
                                  sx={{
                                    width: 36,
                                    height: 36,
                                    bgcolor: getAvatarColor(n.type),
                                  }}
                                >
                                  {renderIcon(n.type)}
                                </Avatar>
                              </ListItemAvatar>

                              <ListItemText
                                primary={
                                  <Typography
                                    variant="body2"
                                    sx={{
                                      color: theme.palette.text.primary,
                                      fontWeight: n.isRead ? 400 : 600,
                                      lineHeight: 1.4,
                                      display: "-webkit-box",
                                      WebkitLineClamp: 2,
                                      WebkitBoxOrient: "vertical",
                                      overflow: "hidden",
                                      textOverflow: "ellipsis",
                                    }}
                                  >
                                    {n.message}
                                  </Typography>
                                }
                                secondary={
                                  <Typography
                                    variant="caption"
                                    sx={{
                                      color: theme.palette.text.secondary,
                                      mt: 0.4,
                                      display: "block",
                                    }}
                                  >
                                    {new Date(n.createdAt).toLocaleString("vi-VN", {
                                      hour: "2-digit",
                                      minute: "2-digit",
                                      day: "2-digit",
                                      month: "2-digit",
                                    })}
                                  </Typography>
                                }
                              />
                            </ListItem>

                            {/* Divider gi·ªØa c√°c item */}
                            {idx < notifications.length - 1 && (
                              <Divider
                                sx={{
                                  mx: 2,
                                  borderColor: theme.palette.divider,
                                  opacity: 0.6,
                                }}
                              />
                            )}
                          </motion.div>
                        ))}
                      </AnimatePresence>
                    )}

                    {/* ‚öôÔ∏è N√∫t Xem th√™m + loader */}
                    {hasMore && (
                      <Box
                        sx={{
                          textAlign: "center",
                          py: 1.5,
                          borderTop: `1px solid ${theme.palette.divider}`,
                        }}
                      >
                        {isLoading ? (
                          <CircularProgress size={22} sx={{ color: theme.palette.primary.main }} />
                        ) : (
                          <Button
                            size="small"
                            onClick={loadMore}
                            sx={{
                              textTransform: "none",
                              color: theme.palette.primary.main,
                              fontWeight: 600,
                            }}
                          >
                            Xem th√™m
                          </Button>
                        )}
                      </Box>
                    )}
                  </List>
                </Box>
              </ClickAwayListener>
            </Paper>
          </Fade>
        )}
      </Popper>
      <NotificationDetailDialog
        open={openDetail}
        onClose={handleCloseDetail}
        notification={selectedNotif}
      />
    </>
  );
}
